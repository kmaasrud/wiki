<!DOCTYPE HTML>
<html color-mode="light">
<head>
<title>My experience with Nix</title>
<meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ffffff" />
<!-- Normalize -->
<link rel="stylesheet" href="../css/normalize.min.css">
<!-- Prism -->
<link rel="stylesheet" href="../css/prism.min.css">
<script src="../js/prism.min.js"></script>
<!-- KaTeX -->
<link rel="stylesheet" href="../css/katex.min.css">
<script src="../js/katex.min.js"></script>
<script src="../js/auto-render.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
renderMathInElement(document.body, {
delimiters: [
{left: '$$', right: '$$', display: true},
{left: '$', right: '$', display: false},
{left: '\\(', right: '\\)', display: false},
{left: '\\[', right: '\\]', display: true}
],
});
});
</script>
<!-- mdzk stylesheet -->
<link rel="stylesheet" href="../css/mdzk.css">
</head>
<body>
<label id="theme-switch" class="theme-switch" for="checkbox_theme">
<input type="checkbox" id="checkbox_theme">
<span></span>
</label>
<main>
<header>

<h1>My experience with Nix</h1>
</header>
<article>
<p>I’ve read a lot about <a href="https://nixos.org">Nix</a> and I’ve even tested it a couple of times, but it was not until yesterday that I was convinced. I did a voicecall with my friend <a href="https://freire.dev.br">@ratsclub</a> and he was showing me these really neat tricks on how I can use Nix and Nix Flakes to define my own reproducible development shell for each project I’m doing - I was blown away. Further research into Nix has shown me just how powerful this tool and language can be. </p>
<p>In this blog post, I will document my firsthand experience with setting up Nix on my system and moving my environment over to it.</p>
<h1>Installing Nix</h1>
<p>I use a Macbook Air M1, and on my first try installing Nix - which was a while ago - I quickly discovered that MacOS made this a hastle. After Catalina, you could not write to the root directory, which meant getting the <code>/nix</code> directory up and running was a struggle. Luckily, there are workarounds and these are now intergrated into the installer, which made the install very simple. A simple</p>
<pre><code>sh &lt;(curl -L https://nixos.org/nix/install)
</code></pre>
<p>did the trick for me! A reboot was needed, but then everything was up and running smoothly.</p>
<h1>Setting up nix-darwin</h1>
<p>I want to manage my system entirely with Nix flakes, so with the guide from <a href="https://github.com/LnL7/nix-darwin#flakes-experimental">here</a> as a template, I started with the following file:</p>
<pre><code class="language-nix">{
  description = &quot;kmaasrud's system&quot;;

  inputs = {
    nixpkgs.url = &quot;github:nixos/nixpkgs/nixpkgs-21.11-darwin&quot;;
    nixpkgs-unstable.url = &quot;github:NixOS/nixpkgs/nixpkgs-unstable&quot;;
    darwin.url = &quot;github:lnl7/nix-darwin/master&quot;;
    darwin.inputs.nixpkgs.follows = &quot;nixpkgs-unstable&quot;;
  };

  outputs = { self, darwin, nixpkgs }: {
    darwinConfigurations = rec {
      mba = darwin.lib.darwinSystem {
        system = &quot;aarch64-darwin&quot;;
        modules = [ ./configuration.nix ];
      };
    }
  };
}
</code></pre>
<p>I put some simple system configuration in <code>configuration.nix</code>, built the flake with </p>
<pre><code>nix build .#darwinConfigurations.mba.system
</code></pre>
<p>and was joyful to see everything working. This gave me the binary <code>./result/sw/bin/darwin-rebuild</code> which I could use to bootstrap the system from the same flake. To my dismay, I was met with an error that said I was missing the <code>/run</code> directory. The error helpfully said that I needed to include the line <code>run\tprivate/var/run</code> in <code>/etc/synthetic.conf</code>, which would create the <a href="https://derflounder.wordpress.com/2020/01/18/creating-root-level-directories-and-symbolic-links-on-macos-catalina/">firmlink</a> I needed. However, it did not tell me I needed to reboot<sup class="footnote-reference"><a href="#1">1</a></sup>… This cost me hours of googling to actually discover.</p>
<p>But alas, I did another reboot and tried <code>./result/sw/bin/darwin-rebuild switch --flake .</code> again. This time the bootstrap ran without issue. A third reboot was needed, before I continued my journey.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>I probably should’ve understood this, but you know how one gets when you are eager to set things up.</p>
</div>
<h1>Next step</h1>

</article>
<footer>
<div class="incoming-links">
<p>

</p>
</div>
</footer>
</main>
<script>
// Determines if the user has a set theme
function detectColorScheme(){
var theme="light"; // default to light
// Local storage is used to override OS theme settings
if (localStorage.getItem("color-mode")) {
if (localStorage.getItem("color-mode") == "dark") {
var theme = "dark";
}
} else if (!window.matchMedia) {
// matchMedia method not supported
return false;
} else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
// OS theme setting detected as dark
var theme = "dark";
}
// Dark theme preferred, set document with a `data-theme` attribute
if (theme == "dark") {
document.documentElement.setAttribute("color-mode", "dark");
}
}
detectColorScheme();
// Identify the toggle switch HTML element
const toggleSwitch = document.querySelector('#theme-switch input[type="checkbox"]');
// Function that changes the theme, and sets a localStorage variable to track the theme between page loads
function switchTheme(e) {
if (e.target.checked) {
localStorage.setItem("color-mode", "dark");
document.documentElement.setAttribute("color-mode", "dark");
toggleSwitch.checked = true;
} else {
localStorage.setItem("color-mode", "light");
document.documentElement.setAttribute("color-mode", "light");
toggleSwitch.checked = false;
}
}
// Listener for changing themes
toggleSwitch.addEventListener('click', switchTheme, false);
// Pre-check the dark-theme checkbox if dark-theme is set
if (document.documentElement.getAttribute("color-mode") == "dark"){
toggleSwitch.checked = true;
}
</script>
</body>
</html>